check_frontend_prerequisites:
  allow_failure: true
  tags:
    - test
  stage: "Frontend Int Tests"
  image: "$SG_BUILD_IMAGE"
  needs:
    - job: build
  artifacts:
    reports:
      dotenv: frontend-int-test.env      
  rules:
    - if: '$DOCKER_ONLY || $CI_COMMIT_MESSAGE =~ /.*SKIP-UT.*/ || $CI_COMMIT_MESSAGE =~ /.*SKIP-TESTS.*/'
      when: never    
    - when: manual      
  script:
    - |

      BRANCH_HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
        --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        "https://git.floragunn.com/api/v4/projects/14/repository/branches/${SG_KI_BRANCH}")

      if [ "${BRANCH_HTTP_CODE}" != "200" ]; then
        echo "ERROR: Branch '${SG_KI_BRANCH}' does NOT exist in search-guard-kibana-plugin"
        exit 1
      fi

      PLUGIN_ARIFACT_URL=$(ci/artifact_uri.sh search-guard-flx-snapshot search-guard-flx-elasticsearch-plugin "${CI_COMMIT_REF_NAME}-SNAPSHOT" .zip)
      KIBANA_ARIFACT_URL=$(ci/artifact_uri.sh search-guard-flx-snapshotXXX search-guard-flx-kibana-plugin "b-${SG_KI_BRANCH}-SNAPSHOT" .zip)


      PLUGIN_HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "${PLUGIN_ARIFACT_URL}")

      if [ "${PLUGIN_HTTP_CODE}" != "200" ]; then
        echo "ERROR: PLUGIN_ARIFACT_URL=${PLUGIN_ARIFACT_URL} not accessible (HTTP ${PLUGIN_HTTP_CODE})"
        exit 1
      fi


      KIBANA_HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "${KIBANA_ARIFACT_URL}")

      if [ "${KIBANA_HTTP_CODE}" != "200" ]; then
        echo "ERROR: Kibana Artifact ${KIBANA_ARIFACT_URL} not exist (HTTP ${KIBANA_HTTP_CODE}) "
        exit 1
      fi
      echo "KIBANA_ARIFACT_URL=$KIBANA_ARIFACT_URL" >> frontend-int-test.env  
      echo "PLUGIN_ARIFACT_URL=$PLUGIN_ARIFACT_URL" >> frontend-int-test.env
      echo "CHECK_FRONTEND_PREREQUISITES=1" >> frontend-int-test.env  


frontend_int_tests:
  allow_failure: false
  stage: "Frontend Int Tests"
  rules:
    - if: '$DOCKER_ONLY || $CI_COMMIT_MESSAGE =~ /.*SKIP-UT.*/ || $CI_COMMIT_MESSAGE =~ /.*SKIP-TESTS.*/'
      when: never    
    - when: on_success
  needs:
    - job: build
    - job: check_frontend_prerequisites
      artifacts: true
  variables:
    SG_ES_PLUGIN: ${PLUGIN_ARIFACT_URL}
    SG_KI_PLUGIN: ${KIBANA_ARIFACT_URL}
    CHECK_JOB_NAME: "check_frontend_prerequisites"
    PARENT_PIPELINE_PREREQUISITES: ${CHECK_FRONTEND_PREREQUISITES}
  trigger:
    strategy: depend
    include:
      - project: search-guard/search-guard-kibana-plugin
        ref: ${SG_KI_BRANCH}
        file: ".gitlab-ci-branch-specific.yml"
      - project: search-guard/search-guard-kibana-plugin
        ref: ${SG_KI_BRANCH}
        file: "ci/frontend-int-tests.yml"

      